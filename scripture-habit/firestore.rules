rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Rules for the 'users' collection
    match /users/{userId} {
      // A user can create their own document upon signup.
      allow create: if request.auth != null && request.auth.uid == userId;

      // A user can read any user document (needed for group members list).
      allow read: if request.auth != null;

      // A user can update their own document.
      allow update: if request.auth != null && request.auth.uid == userId;

      // Rules for the 'notes' subcollection
      match /notes/{noteId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Rules for the 'groupStates' subcollection (for tracking read message counts)
      match /groupStates/{groupId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Rules for the 'letters' subcollection (for weekly recaps)
      match /letters/{letterId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Rules for the 'groups' collection
    match /groups/{groupId} {
      // 読み取り: ログインユーザーなら基本読み取りは許可（権限確認やリスト表示に必要）
      allow read: if request.auth != null;

      // A user can create a group, but they must set themselves as the owner.
      allow create: if request.auth != null &&
                    request.auth.uid == request.resource.data.ownerUserId;
      
      // 更新権限
      allow update: if request.auth != null && (
        // A. オーナーは何でも更新可能
        resource.data.get('ownerUserId', '') == request.auth.uid ||
        // B. メンバーは統計情報の更新のみ可能（重要な設定などは変更不可）
        (
          request.auth.uid in resource.data.get('members', []) &&
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['ownerUserId', 'inviteCode', 'members'])
        )
      );
      
      // Allow deletion if the user is the owner
      allow delete: if request.auth != null && resource.data.get('ownerUserId', '') == request.auth.uid;
      
      // Rules for the 'messages' subcollection
      match /messages/{messageId} {
        // Only group members or the owner can read or write messages.
        allow read, write: if request.auth != null &&
                           (
                             request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.get('members', []) ||
                             get(/databases/$(database)/documents/groups/$(groupId)).data.get('ownerUserId', '') == request.auth.uid
                           );
      }
    }

    // Rules for the 'system' collection (Maintenance & Status)
    match /system/{docId} {
      // Allow anyone to read the status to check for maintenance mode/quota issues
      // This is necessary to show the maintenance page before the user logs in
      allow read: if true;
      // No one can write via client
      allow write: if false;
    }
  }
}
