rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Rules for the 'users' collection
    match /users/{userId} {
      // A user can create their own document upon signup.
      allow create: if request.auth != null && request.auth.uid == userId;

      // A user can read any user document (needed for group members list).
      allow read: if request.auth != null;

      // A user can update or delete their own document.
      allow update, delete: if request.auth != null && request.auth.uid == userId;

      // Rules for the 'notes' subcollection
      match /notes/{noteId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Rules for the 'groupStates' subcollection (for tracking read message counts)
      match /groupStates/{groupId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Rules for the 'letters' subcollection (for weekly recaps)
      match /letters/{letterId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Rules for the 'groups' collection
    match /groups/{groupId} {
      // 読み取り: プレビュー表示などのためにパブリックに許可（メッセージは別で保護）
      allow read: if true;

      // A user can create a group, but they must set themselves as the owner.
      allow create: if request.auth != null &&
                    request.auth.uid == request.resource.data.ownerUserId;
      
      // 更新権限
      allow update: if request.auth != null && (
        // A. オーナーは何でも更新可能
        resource.data.get('ownerUserId', '') == request.auth.uid ||
        // B. メンバーは自身の脱退、または統計情報の更新が可能
        (
          request.auth.uid in resource.data.get('members', []) &&
          (
            // 特例: メンバーリストから「自分のUIDのみ」が削除される操作を許可（脱退）
            (
              request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members']) &&
              !(request.auth.uid in request.resource.data.members)
            ) ||
            // または、重要な管理項目（オーナー、招待コード、メンバー）が変更されていない（統計更新）
            !request.resource.data.diff(resource.data).affectedKeys().hasAny(['ownerUserId', 'inviteCode', 'members'])
          )
        )
      );
      
      // Allow deletion if the user is the owner
      allow delete: if request.auth != null && resource.data.get('ownerUserId', '') == request.auth.uid;
      
      // Rules for the 'messages' subcollection
      match /messages/{messageId} {
        // Only group members or the owner can read or write messages.
        allow read, write: if request.auth != null &&
                           (
                             request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.get('members', []) ||
                             get(/databases/$(database)/documents/groups/$(groupId)).data.get('ownerUserId', '') == request.auth.uid
                           );
      }
    }

    // Rules for the 'system' collection (Maintenance & Status)
    match /system/{docId} {
      // Allow anyone to read the status to check for maintenance mode/quota issues
      // This is necessary to show the maintenance page before the user logs in
      allow read: if true;
      // No one can write via client
      allow write: if false;
    }
    // Rules for the 'cheers' collection
    match /cheers/{cheerId} {
      // Users can read cheers where they are the sender
      allow read: if request.auth != null && (
        resource.data.senderUid == request.auth.uid || 
        resource.data.targetUid == request.auth.uid
      );
      // Writes are exclusively handled by the backend API
      allow write: if false;
    }
  }
}
